===========
fRingCipher
===========


■ソフトの概要

　ファイルを暗号化・復号するコンソールアプリケーションです。


■動作環境

　Windows 11


■インストール方法

　アーカイブの中身をローカルディスク上の任意の場所にコピーして下さい。


■アンインストール方法

　レジストリなどは一切使っていません。
　ファイルを削除するだけでアンインストールできます。


■実行方法

　fRingCipher.exe [/B] [/S] [/R] [/E | /D] /P PASS-PHRASE [/PE X-CHR X-EXP] INPUT-FILE [OUTPUT-FILE]

　　/B          ... バッチモード
　　/S          ... サイレントモード
　　/R          ... 入力ファイルを削除する ※1
　　/E          ... 暗号化モード
　　/D          ... 復号モード
　　PASS-PHRASE ... パスフレーズ
　　X-CHR       ... パスフレーズ延長文字
　　X-EXP       ... パスフレーズ延長スケール
　　INPUT-FILE  ... 入力ファイル
　　OUTPUT-FILE ... 出力ファイル

　　復号に失敗すると出力ファイルは常に削除します。
　　/B /S /R /E /D /P /PE オプションは順序を入れ替えても問題ありません。(/P と PASS-PHRASE はセットです)


　●バッチモード

　　メッセージボックスの表示を抑止し、問い合わせや入力待ちを行わないようにします。


　●サイレントモード

　　標準出力を行わないようにします。


　●パスフレーズ

　　暗号化・復号に使用する共通鍵を指定します。
　　本プログラムが使用する鍵の長さは 512 ビットです。
　　128桁の16進数、つまり 0〜9, a〜f, A〜F の文字だけで構成された長さ128の文字列である場合、
　　そのまま鍵として使用します。
　　それ以外の場合、文字列の SHA-512 を鍵として使用します。
　　文字コードは CP932 です。

　　★パスフレーズが間違っているかファイルが破損していると、復号は失敗します。


　●パスフレーズの延長

　　/PE オプションを指定するとパスフレーズに [ランダムなバイト列_64バイト] + [ X-CHR を 2^(X-EXP) 個] を追加します。
　　これにより、非常に長いパスフレーズを使用することができます。
　　例えば、/P ABCDEF を指定した場合のパスフレーズは

　　　ABCDEF

　　ですが、/P ABCDEF /PE x 30 を指定した場合のパスフレーズは

　　　ABCDEF??????????...??????????xxxxxxxxxx...xxxxxxxxxx
　　　      |<---- 64 バイト ---->||<--- 2^30 バイト --->|

　　　　? ＝ 0x00 〜 0xFF のランダムバイト ※2

　　になります。
　　復号時もパスワードと同様に(暗号化時に指定したものと同じ) X-CHR, X-EXP を指定する必要があります。

　　X-CHR には任意の1バイトを指定できます。
　　1文字(アスキー文字)を直接指定するか、
　　2桁の16進数(0〜9, a〜f, A〜F の文字だけで構成された長さ2の文字列)を指定してください。
　　例えば /PE _ 20 と /PE 5f 20 は同じです。

　　X-EXP に指定できる値は 20〜50 です。

　　X-EXP が十分に大きければ鍵の生成に時間が掛かるため、
　　総当たり攻撃に対して有利になる可能性があります。
　　但し暗号理論的に暗号強度を保証するものではありません。


　●出力ファイルを省略した場合

　　暗号化モードであれば、入力ファイルに .cphr を付加した名前になります。
　　復号モードであれば、入力ファイルの拡張子を取り除いた名前になり、拡張子が無ければ .dec を付加します。


　●暗号化・復号モードを省略した場合

　　入力ファイルの拡張子が .cphr である場合、復号モードに、
　　それ以外は暗号化モードになります。


　●実行例

　　fRingCipher.exe /E /P 花鳥風月 C:\Data\Plain.txt C:\tmp\Cipher.enc

　　　... 入力ファイル "C:\Data\Plain.txt" をパスフレーズ "花鳥風月" で暗号化して "C:\tmp\Cipher.enc" に出力する。

　　fRingCipher.exe /D /P 東北自動車道 Encrypt.bin sub\Decrypt.bin

　　　... 入力ファイル ".\Encrypt.bin" をパスフレーズ "東北自動車道" で復号して ".\sub\Decrypt.bin" に出力する。

　　fRingCipher.exe /P 風花雪月 123.dat

　　　... 入力ファイル ".\123.dat" をパスフレーズ "風花雪月" で暗号化して ".\123.dat.cphr" に出力する。

　　fRingCipher.exe /P 紅孔雀 ..\ABC.txt.cphr

　　　... 入力ファイル "..\ABC.txt.cphr" をパスフレーズ "紅孔雀" で復号して "..\ABC.txt" に出力する。

　　fRingCipher.exe /B /S /P "autumn breeze" golden.hour cool.air

　　　... バッチモード＆サイレントモードで、入力ファイル ".\golden.hour" をパスフレーズ "autumn breeze" で暗号化して ".\cool.air" に出力する。

　　fRingCipher.exe /E /P あいうえお /PE x 30 aiueo.in aiueo.out

　　　... 入力ファイル ".\aiueo.in" をパスフレーズ "あいうえお" + ( ランダムなバイト × 64 ) + ( 0x78 × 2^30 ) で暗号化して ".\aiueo.out" に出力する。

　　　　　★ 0x78 は "x" の文字コード(アスキーコード)

　　fRingCipher.exe /D /P あいうえお /PE x 30 aiueo.out aiueo.in-dec

　　　... 上で暗号化した ".\aiueo.out" を復号して ".\aiueo.in-dec" に出力する。

　　　　　★ /PE オプション付きで暗号化したファイルを復号するには、暗号化時と同じ /PE オプションを指定する必要があります。

　　fRingCipher.exe /E /P 6ac43722c0d920d852e69ac6552caf1602852b74cbd63dcce7d9ba4f79e6038dcc68169d882f96bcd2fb452c1e4b1f0f9e6e61aece605a8cd5c173c7bba329fb Plain.dat

　　　... 入力ファイル ".\Plain.dat" を、指定された512ビットの鍵(6ac4...29fb)で暗号化して ".\Plain.dat.cphr" に出力する。


■パスフレーズ・鍵の生成

　以下のコマンドを実行すると、ランダムなパスフレーズを標準出力します。※2

　　fRingCipher.exe /MP [P-LEN]

　　　P-LEN ... パスフレーズの文字数, デフォルトは 22 文字, 指定できる範囲は 3 〜 1000

　　　パスフレーズは以下の文字グループから構成され、それぞれ 1 文字以上出現するようにします。
　　　・半角英大文字
　　　・半角英小文字
　　　・半角数字


　以下のコマンドを実行すると、ランダムな鍵を標準出力します。※2

　　fRingCipher.exe /MK


　●実行例

　　fRingCipher.exe /MP

　　fRingCipher.exe /MP 10

　　fRingCipher.exe /MK


■暗号化の実装

　CIPHER = rCBC ( rCBC ( PLAIN + padding + padding_N + randPart + hash + iv , key1 ) , key2 ) + PERandPart

　　PLAIN  ... 平文のバイト列
　　CIPHER ... 暗号化されたバイト列

　　padding        ... ランダムなバイト列 (padding_N-Low バイト) ※2
　　padding_N(Hi)  ... ランダムなビット列 (上位4ビット) ※2
　　padding_N(Low) ... PLAIN + padding + padding_N のバイト数が16の倍数となるような 1〜15 の値 (下位4ビット)
　　randPart       ... ランダムなバイト列 (64バイト) ※2
　　hash           ... PLAIN + padding + padding_N + randPart の SHA-512 (64バイト) ※3
　　iv             ... ランダムなバイト列 (16バイト) ※2
　　key1           ... 鍵の前半256ビット
　　key2           ... 鍵の後半256ビット
　　rCBC           ... 鍵長256ビットのAESによる暗号化, 最後のブロックをIVとするCBCモード ※4

　　PERandPart ... /PE オプションを指定した場合、/PE オプションで使用する「ランダムなバイト列_64バイト」(64バイト)
　　               /PE オプションを指定しなかった場合、何も無し (0バイト)


■取り扱い種別

　フリーソフト


■注釈

　　※1 このオプションを指定して復号に失敗すると、入力・出力ファイル共に削除されることに注意して下さい。
　　※2 乱数は CSPRNG (CSPRNGRandomizer) から取得します。
　　※3 復号時 hash が一致しなければ、鍵の不一致かファイルの破損(改ざん)と見なします。
　　※4 例えば P1 + P2 + P3 を暗号化した C1 + C2 + C3 は以下のとおりになります。(Px,Cx はそれぞれ1ブロック)
　　　　C1 = encrypt ( xor ( P1 , P3 ) )
　　　　C2 = encrypt ( xor ( P2 , C1 ) )
　　　　C3 = encrypt ( xor ( P3 , C2 ) )

